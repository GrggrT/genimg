# GenImg Pro: Техническое Задание v2.0

Документ подготовил: Gemini (AI ассистент)  
Версия: 2.0  
Дата: 15.06.2025

## 1. Введение

### 1.1. Наименование проекта: GenImg Pro

### 1.2. Цель проекта
Создание профессионального десктопного приложения для Windows, macOS и Linux, которое автоматизирует полный цикл производства графического контента для спортивных анонсов: от сбора данных и генерации изображений по шаблонам до перевода и подготовки к публикации в Telegram.

### 1.3. Ключевые изменения в v2.0 (по сравнению с v1.2):
- **Архитектура MVVM**: Внедрение четкой архитектурной модели (Model-View-ViewModel) для разделения логики данных, интерфейса и управления.
- **Централизованный кэш на SQLite**: Переход от файлового кэша к базе данных SQLite для более надежного и быстрого управления логотипами и метаданными.
- **Шаблонизация макетов**: Отказ от жестко запрограммированных макетов в пользу внешних конфигурационных файлов (JSON), что позволяет изменять дизайн постов без изменения кода.
- **Продвинутое управление состоянием**: Внедрение механизмов сохранения и загрузки сессии пользователя.
- **Система логирования**: Добавление централизованной системы логирования для упрощения отладки и поддержки.
- **Стратегия развертывания**: Включение в план этапа упаковки приложения в исполняемый файл.

## 2. Архитектура Системы (Model-View-ViewModel)

Проект будет построен на архитектурном паттерне MVVM, что обеспечивает максимальное разделение ответственностей и упрощает тестирование и поддержку.

### Model (Модель): Отвечает за всю логику данных.
- API-клиенты (для API-Football, TheSportsDB, DeepL).
- Менеджер кэша (взаимодействие с базой данных SQLite).
- Система логирования.

### View (Представление): Отвечает исключительно за отображение.
- Окна, виджеты и элементы управления, созданные с помощью PySide6.
- Не содержит никакой бизнес-логики. Только отправляет действия пользователя в ViewModel и отображает данные, которые из нее получает.

### ViewModel (Модель Представления): "Мозг" приложения.
- Связующее звено между Model и View.
- Обрабатывает действия пользователя (нажатия кнопок, ввод текста).
- Запускает фоновые задачи (загрузка логотипов через QThread).
- Управляет состоянием приложения (какие команды введены, какой тип поста выбран).
- Предоставляет данные из Model в готовом для отображения виде для View.

## 3. Требования к Модулям

### 3.1. Ядро (Core / Model)

#### 3.1.1. Управление кэшем (SQLite):
- **Технология**: Вместо отдельных файлов для кэша и timestamp'ов будет использоваться единая база данных cache.db на основе SQLite.
- **Структура таблицы teams_cache**:
  - id (INTEGER PRIMARY KEY)
  - team_name_normalized (TEXT, UNIQUE) - Название команды в нижнем регистре.
  - logo_path (TEXT) - Путь к скачанному файлу логотипа в LOGO_DIR.
  - api_source (TEXT) - Источник ('api-football', 'thesportsdb').
  - last_updated_ts (INTEGER) - Unix timestamp последнего обновления.
- **Логика инвалидации**: Перед запросом к API система проверяет last_updated_ts. Если запись старше 30 дней, она считается устаревшей и подлежит обновлению.

#### 3.1.2. API-клиенты:
- Будет создан базовый класс APIBaseClient с общей логикой (обработка ошибок, таймауты) и два потомка: APIFootballClient и TheSportsDBClient.
- **Стратегия запросов**: ViewModel последовательно обращается к APIFootballClient. В случае неудачи (ошибка сети, команда не найдена, нет логотипа) обращается к TheSportsDBClient. Если оба отказали, в лог пишется ошибка, а пользователю в статус-бар выводится сообщение.

#### 3.1.3. Централизованное логирование:
- Используется встроенный модуль logging.
- **Конфигурация**: Настройка двух обработчиков (Handlers):
  - StreamHandler: выводит DEBUG-сообщения в консоль для разработки.
  - FileHandler: пишет INFO-сообщения и ошибки в файл app.log для последующего анализа.
- **Формат лога**: [YYYY-MM-DD HH:MM:SS] [LEVEL] - message.

### 3.2. Пользовательский Интерфейс (View & ViewModel)

#### 3.2.1. Фреймворк: PySide6 — подтверждено как оптимальный выбор.

#### 3.2.2. Асинхронные операции: Для всех сетевых запросов (превью логотипа, перевод) будет использоваться QThread для выноса операций из основного потока GUI. ViewModel будет отвечать за создание и запуск этих потоков, а View будет подписываться на их сигналы (finished, error) для обновления интерфейса.

#### 3.2.3. Уведомление пользователя: В главном окне приложения будет реализован QStatusBar. Он будет отображать текущий статус ("Готово", "Загрузка логотипа...", "Ошибка: команда не найдена", "Ошибка сети").

#### 3.2.4. Сохранение состояния: При закрытии приложения ViewModel будет сохранять текущие введенные данные (названия команд, текст прогноза) в файл session.json. При запуске эти данные будут загружаться обратно в поля ввода, улучшая user experience.

### 3.3. Генератор Изображений (Image Generator)

#### 3.3.1. Библиотека: Pillow — подтверждено.

#### 3.3.2. Шаблонизация макетов (ключевое улучшение):
Вместо жестко закодированных координат, все параметры макетов ("Одиночный", "Экспресс") будут вынесены в файлы single_layout.json и express_layout.json.

Структура JSON-шаблона:
```json
{
  "base_image": "templates/background_single.png",
  "elements": {
    "team1_logo": { "coords": [100, 200], "size": [150, 150] },
    "team2_logo": { "coords": [750, 200], "size": [150, 150] },
    "team1_name": {
      "coords": [100, 370],
      "font": "fonts/Montserrat-Bold.ttf",
      "font_size": 32,
      "color": "#FFFFFF"
    }
  }
}
```

Преимущество: Это позволяет дизайнеру или пользователю изменять внешний вид постов, просто редактируя JSON-файл, без необходимости переписывать код на Python.

### 3.4. Управление Зависимостями и Секретами

#### 3.4.1. Секреты: Использование .env и библиотеки python-dotenv — подтверждено как обязательное.

#### 3.4.2. Зависимости: Использование pip freeze > requirements.txt для фиксации точных версий — подтверждено.

## 4. Нефункциональные Требования

К существующим требованиям (Отзывчивость, Надежность, Кроссплатформенность) добавляются:
- **Поддерживаемость (Maintainability)**: Благодаря архитектуре MVVM и шаблонизации, код становится легче читать, тестировать и модифицировать.
- **Развертываемость (Deployability)**: Проект должен быть готов к упаковке в единый исполняемый файл с помощью PyInstaller. В README.md должна быть инструкция по сборке.

## 5. План Разработки (Roadmap)

План пересмотрен для отражения новой архитектуры:

### Этап 1: Фундамент и Ядро.
- Настройка структуры проекта (папки core, gui, assets).
- Реализация менеджера кэша на SQLite.
- Написание API-клиентов для API-Football и TheSportsDB.
- Настройка системы логирования.

### Этап 2: Прототип GUI и ViewModel.
- Создание основного окна приложения на PySide6.
- Реализация ViewModel для управления состоянием "Одиночного" режима.
- Реализация фоновой загрузки логотипа через QThread и его отображения.

### Этап 3: Генерация и Расширение.
- Интеграция генератора изображений на основе JSON-шаблонов.
- Добавление логики для "Экспресс" режима в GUI и ViewModel.
- Интеграция DeepL API для перевода.

### Этап 4: Тестирование и Развертывание.
- Написание модульных тестов (unittest/pytest) с использованием "моков" для API.
- Создание конфигурационного файла для PyInstaller и сборка тестовой версии приложения.

### Этап 5 (Будущее): Интеграция с Telegram.
- Разработка бота на aiogram, который будет импортировать и использовать функции из core и image_generator для выполнения своих задач. 